<!DOCTYPE html>  
<html lang="fr">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>Contrôle Qualité des Données</title>  
    <script src="https://cdn.tailwindcss.com"></script>  
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">  
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

</head>  
<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen">  
    <nav class="bg-white shadow">  
        {% include 'csv_anonymizer/datasteward_navigation.html' %}  
    </nav>  
  
    <div class="container mx-auto px-4 py-8">  
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-8">  
            <h1 class="text-3xl font-light text-slate-700 mb-8 flex items-center">  
                <i class="fas fa-chart-line text-blue-500 mr-4"></i>  
                Contrôle Qualité des Données  
            </h1>  
  
            <!-- Tableau de bord qualité -->  
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">  
                <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 border border-emerald-200 rounded-xl p-6">  
                    <div class="flex items-center justify-between">  
                        <div>  
                            <p class="text-emerald-600 text-sm font-medium mb-1">Score de Complétude</p>  
                            <p class="text-3xl font-bold text-emerald-700">{{ quality_analysis.completeness.score }}%</p>  
                        </div>  
                        <div class="bg-emerald-100 rounded-full p-3">  
                            <i class="fas fa-check-circle text-2xl text-emerald-600"></i>  
                        </div>  
                    </div>  
                </div>  
  
                <div class="bg-gradient-to-br from-amber-50 to-amber-100 border border-amber-200 rounded-xl p-6">  
                    <div class="flex items-center justify-between">  
                        <div>  
                            <p class="text-amber-600 text-sm font-medium mb-1">Problèmes de Cohérence</p>  
                            <p class="text-3xl font-bold text-amber-700">{{ quality_analysis.consistency.total_issues }}</p>  
                        </div>  
                        <div class="bg-amber-100 rounded-full p-3">  
                            <i class="fas fa-exclamation-triangle text-2xl text-amber-600"></i>  
                        </div>  
                    </div>  
                </div>  
  
                <div class="bg-gradient-to-br from-rose-50 to-rose-100 border border-rose-200 rounded-xl p-6">  
                    <div class="flex items-center justify-between">  
                        <div>  
                            <p class="text-rose-600 text-sm font-medium mb-1">Doublons Détectés</p>  
                            <p class="text-3xl font-bold text-rose-700">{{ quality_analysis.duplicates.total_issues }}</p>  
                        </div>  
                        <div class="bg-rose-100 rounded-full p-3">  
                            <i class="fas fa-copy text-2xl text-rose-600"></i>  
                        </div>  
                    </div>  
                </div>  
            </div>  
  
            <!-- Section Actions de Nettoyage Consolidée -->  
            <div class="bg-gradient-to-br from-indigo-50 to-purple-50 border border-indigo-200 rounded-2xl p-8 mb-10 shadow-lg">  
                <div class="flex items-center mb-8">  
                    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full p-4 mr-4">  
                        <i class="fas fa-magic text-white text-2xl"></i>  
                    </div>  
                    <div>  
                        <h2 class="text-2xl font-bold text-slate-800 mb-1">  
                            Actions de Nettoyage Intelligentes  
                        </h2>  
                        <p class="text-slate-600 text-sm">  
                            Sélectionnez les corrections à appliquer automatiquement  
                        </p>  
                    </div>  
                </div>  
                  
                <!-- Grille des options de nettoyage -->  
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">  
                    <!-- Option Doublons -->  
                    <div class="cleaning-card bg-white border-2 border-slate-200 rounded-xl p-6 cursor-pointer transition-all duration-300 hover:border-blue-300 hover:shadow-md" onclick="toggleCard('removeDuplicates')">  
                        <div class="flex items-center justify-between mb-4">  
                            <div class="bg-blue-100 rounded-lg p-3">  
                                <i class="fas fa-copy text-blue-600 text-xl"></i>  
                            </div>  
                            <input type="checkbox" id="removeDuplicates" class="w-5 h-5 text-blue-600 rounded" onclick="event.stopPropagation()">  
                        </div>  
                        <h3 class="font-semibold text-slate-800 mb-2">Supprimer les doublons</h3>  
                        <p class="text-sm text-slate-600 mb-3">Éliminer automatiquement les lignes dupliquées</p>  
                        <div class="mt-auto">  
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-rose-100 text-rose-700">  
                                <i class="fas fa-exclamation-circle mr-1"></i>  
                                {{ quality_analysis.duplicates.total_issues }} détectés  
                            </span>  
                        </div>  
                    </div>  
  
                    <!-- Option Valeurs manquantes -->  
                    <div class="cleaning-card bg-white border-2 border-slate-200 rounded-xl p-6 cursor-pointer transition-all duration-300 hover:border-orange-300 hover:shadow-md" onclick="toggleCard('removeMissingValues')">  
                        <div class="flex items-center justify-between mb-4">  
                            <div class="bg-orange-100 rounded-lg p-3">  
                                <i class="fas fa-exclamation-triangle text-orange-600 text-xl"></i>  
                            </div>  
                            <input type="checkbox" id="removeMissingValues" class="w-5 h-5 text-orange-600 rounded" onclick="event.stopPropagation()">  
                        </div>  
                        <h3 class="font-semibold text-slate-800 mb-2">Supprimer les valeurs manquantes</h3>  
                        <p class="text-sm text-slate-600 mb-3">Nettoyer les lignes avec des cellules vides</p>  
                        <div class="mt-auto">  
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-amber-100 text-amber-700">  
                                <i class="fas fa-database mr-1"></i>  
                                {{ quality_analysis.completeness.total_missing }} cellules  
                            </span>  
                        </div>  
                    </div>  
  
                    <!-- Option Incohérences -->  
                    <div class="cleaning-card bg-white border-2 border-slate-200 rounded-xl p-6 cursor-pointer transition-all duration-300 hover:border-purple-300 hover:shadow-md" onclick="toggleCard('fixInconsistencies')">  
                        <div class="flex items-center justify-between mb-4">  
                            <div class="bg-purple-100 rounded-lg p-3">  
                                <i class="fas fa-balance-scale text-purple-600 text-xl"></i>  
                            </div>  
                            <input type="checkbox" id="fixInconsistencies" class="w-5 h-5 text-purple-600 rounded" onclick="event.stopPropagation()">  
                        </div>  
                        <h3 class="font-semibold text-slate-800 mb-2">Corriger les incohérences</h3>  
                        <p class="text-sm text-slate-600 mb-3">Standardiser les formats et valeurs</p>  
                        <div class="mt-auto">  
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-700">  
                                <i class="fas fa-cog mr-1"></i>  
                                {{ quality_analysis.consistency.total_issues }} problèmes  
                            </span>  
                        </div>  
                    </div>  
                </div>  
                  
                <!-- Bouton d'action principal -->  
                <div class="text-center">  
                    <button onclick="applySelectedCleaningActions()"  
    style="padding:12px 24px; 
           background: linear-gradient(90deg, #10b981, #0d9488); 
           color:white; 
           font-size:16px; 
           font-weight:bold; 
           border:none; 
           border-radius:12px; 
           cursor:pointer; 
           box-shadow:0 4px 8px rgba(0,0,0,0.2); 
           transition:all 0.3s ease;">
    Appliquer les corrections sélectionnées
</button>
  
                    <p class="text-sm text-slate-500 mt-3">  
                        Le fichier nettoyé sera automatiquement téléchargé  
                    </p>  
                </div>  
            </div>  
        </div>  
    </div>  
  
    <style>  
    .cleaning-card.selected {  
        border-color: #3b82f6;  
        background-color: #eff6ff;  
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);  
    }  
    </style>  
  
    <script>  
    function toggleCard(checkboxId) {  
        const checkbox = document.getElementById(checkboxId);  
        const card = checkbox.closest('.cleaning-card');  
          
        checkbox.checked = !checkbox.checked;  
          
        if (checkbox.checked) {  
            card.classList.add('selected');  
        } else {  
            card.classList.remove('selected');  
        }  
    }  
  
    function applySelectedCleaningActions() {  
        const selectedActions = [];  
          
        if (document.getElementById('removeDuplicates').checked) {  
            selectedActions.push('remove_duplicates');  
        }  
        if (document.getElementById('removeMissingValues').checked) {  
            selectedActions.push('remove_missing_values');  
        }  
        if (document.getElementById('fixInconsistencies').checked) {  
            selectedActions.push('fix_inconsistencies');  
        }  
          
        if (selectedActions.length === 0) {  
            showErrorMessage('Veuillez sélectionner au moins une action de nettoyage');  
            return;  
        }  
          
        showLoadingIndicator('Application des corrections en cours...');  
          
        const formData = new FormData();  
        formData.append('action', 'batch_cleaning');  
        formData.append('selected_actions', JSON.stringify(selectedActions));  
          
        fetch(`/recommendations/data-quality/{{ job_id }}/`, {  
            method: 'POST',  
            headers: {  
                'X-CSRFToken': getCookie('csrftoken')  
            },  
            body: formData  
        })  
        .then(response => {  
            if (!response.ok) {  
                throw new Error(`Erreur HTTP: ${response.status}`);  
            }  
            return response.json();  
        })  
        .then(data => {  
            hideLoadingIndicator();  
            if (data.success) {  
                showSuccessMessage(`Nettoyage terminé ! ${data.total_changes} modifications appliquées`);  
                  
                // Téléchargement automatique unique du fichier final  
                downloadProcessedFile('{{ job_id }}', 'cleaned');  
                  
                setTimeout(() => {  
                    window.location.reload();  
                }, 3000);  
            } else {  
                showErrorMessage(data.error || 'Erreur lors du nettoyage');  
            }  
        })  
        .catch(error => {  
            hideLoadingIndicator();  
            showErrorMessage(error.message || 'Erreur de connexion');  
        });  
    }  
  
    // Fonction pour télécharger automatiquement le fichier traité  
    function downloadProcessedFile(jobId, actionType) {  
        // Créer un lien de téléchargement invisible  
        const downloadLink = document.createElement('a');  
        downloadLink.href = `/download/${jobId}/`;  
        downloadLink.download = `processed_file_${actionType}_${jobId}.csv`;  
        downloadLink.style.display = 'none';  
          
        // Ajouter au DOM, cliquer, puis supprimer  
        document.body.appendChild(downloadLink);  
        downloadLink.click();  
        document.body.removeChild(downloadLink);  
          
        showSuccessMessage('Téléchargement du fichier traité en cours...');  
    }  
  
    // Fonctions utilitaires  
    function getCookie(name) {  
        let cookieValue = null;  
        if (document.cookie && document.cookie !== '') {  
            const cookies = document.cookie.split(';');  
            for (let i = 0; i < cookies.length; i++) {  
                const cookie = cookies[i].trim();  
                if (cookie.substring(0, name.length + 1) === (name + '=')) {  
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));  
                    break;  
                }  
            }  
        }  
        return cookieValue;  
    }  
  
    function showLoadingIndicator(message) {  
        const loader = document.createElement('div');  
        loader.id = 'loadingIndicator';  
        loader.className = 'fixed inset-0 bg-slate-900 bg-opacity-50 z-50 flex items-center justify-center';  
        loader.innerHTML = `  
            <div class="bg-white rounded-xl p-6 flex items-center shadow-2xl">  
                <i class="fas fa-spinner fa-spin text-blue-500 text-2xl mr-3"></i>  
                <span class="text-slate-700 font-medium">${message}</span>  
            </div>  
        `;  
        document.body.appendChild(loader);  
    }  
    function hideLoadingIndicator() {  
        const loader = document.getElementById('loadingIndicator');  
        if (loader) {  
            loader.remove();  
        }  
    }  
  
    function showSuccessMessage(message) {  
        showToast(message, 'success');  
    }  
  
    function showErrorMessage(message) {  
        showToast(message, 'error');  
    }  
  
    function showToast(message, type) {  
        const toast = document.createElement('div');  
        toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-xl text-white shadow-lg transform transition-all duration-300 ${  
            type === 'success' ? 'bg-emerald-500' : 'bg-rose-500'  
        }`;  
        toast.innerHTML = `  
            <div class="flex items-center">  
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} mr-2"></i>  
                <span class="font-medium">${message}</span>  
            </div>  
        `;  
        document.body.appendChild(toast);  
  
        // Animation d'entrée  
        setTimeout(() => {  
            toast.style.transform = 'translateX(0)';  
            toast.style.opacity = '1';  
        }, 100);  
  
        // Suppression après 3 secondes  
        setTimeout(() => {  
            toast.style.transform = 'translateX(100%)';  
            toast.style.opacity = '0';  
            setTimeout(() => {  
                toast.remove();  
            }, 300);  
        }, 3000);  
    }  
</script>  
</body>  
</html>
